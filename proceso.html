<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChidoCar - Selecciona Categoría</title>

  <!-- Font Awesome (mismos iconos que en la otra página) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --muted:#9ca3af;
      --bg:#f7f9fb;
      --card:#ffffff;
      --accent:#10b981;
      --radius:12px;
      --shadow: 0 8px 30px rgba(37, 99, 235, 0.08);
      --blue-soft: rgba(37,99,235,0.08);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    .wrap{max-width:1200px;margin:40px auto;padding:0 24px;display:grid;grid-template-columns:1fr 380px;gap:40px;align-items:start}

    /* ========== HEADER (igual que index.html) ========== */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    header.app-header {
      background: white;
      padding: 20px 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      position: relative;
      z-index: 100;
      animation: fadeInDown 0.8s ease-out;
      border-radius: 12px;
    }

    .logo {
      height: 60px;
      width: auto;
      transition: transform 0.3s ease;
      cursor: pointer;
    }

    .logo:hover { transform: scale(1.05); }

    nav.top-nav {
      display: flex;
      gap: 28px;
      align-items: center;
    }

    nav.top-nav a {
      color: #666;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
    }

    nav.top-nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    nav.top-nav a:hover { color: var(--primary); }
    nav.top-nav a:hover::after { width: 100%; }

    /* Loader overlay */
    .loader-overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(245,247,250,0.9));
      z-index:9999;backdrop-filter: blur(6px);transition:opacity .4s ease;
    }
    .loader-card{background:var(--card);padding:26px;border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:14px;align-items:center}
    .spinner{
      width:56px;height:56px;border-radius:50%;border:5px solid #e6eefc;border-top-color:var(--primary);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader-text{font-weight:700;color:var(--primary)}
    .loader-sub{font-size:13px;color:var(--muted)}

    /* Left column: categories */
    .panel{background:var(--card);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow);animation:fadeInUp .6s both}
    h1.title{font-size:26px;margin-bottom:6px}
    p.lead{color:var(--muted);margin-bottom:18px}

    .categories{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .cat{
      display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:10px;border:1px solid rgba(15,23,42,0.04);
      transition:all .25s ease;cursor:pointer;background:linear-gradient(180deg, transparent, rgba(0,0,0,0.01));
      position:relative;overflow:hidden;
    }
    .cat:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(16,24,40,0.06)}
    .cat.selected{border:2px solid var(--primary);box-shadow:0 12px 32px var(--blue-soft);background:linear-gradient(180deg, rgba(37,99,235,0.03), transparent)}
    .cat-left{display:flex;gap:14px;align-items:center;min-width:0}
    .radio-custom{
      width:18px;height:18px;border-radius:50%;border:2px solid var(--muted);display:flex;align-items:center;justify-content:center;flex-shrink:0;
      background:white;transition:all .22s ease;margin-right:6px;
    }
    .cat.selected .radio-custom{border-color:var(--primary);background:var(--primary)}
    .radio-custom i{color:white;font-size:10px;opacity:0;transition:opacity .18s}
    .cat.selected .radio-custom i{opacity:1}

    .cat-info{min-width:0}
    .cat-name{font-weight:700;font-size:15px;color:#0b1220;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cat-desc{font-size:13px;color:var(--muted);margin-top:4px;max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .cat-price{font-weight:800;color:var(--primary);font-size:16px;min-width:72px;text-align:right}

    /* Disabled small details */
    .small-note{font-size:13px;color:var(--muted);margin-top:14px}

    /* Right column: resumen */
    .summary{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:var(--radius);padding:22px;border:1px solid rgba(15,23,42,0.03);box-shadow:var(--shadow);position:sticky;top:26px;align-self:start;animation:fadeInUp .6s .15s both}
    .summary h3{margin-bottom:6px;color:#111827}
    .step{font-size:13px;color:var(--muted);float:right}
    .summary-row{display:flex;justify-content:space-between;padding:10px 6px;border-bottom:1px dashed rgba(15,23,42,0.05);align-items:center}
    .summary-row strong{color:#111827}
    .total{display:flex;justify-content:space-between;padding-top:18px;align-items:center}
    .total strong{font-size:20px}
    .total .amount{color:var(--primary);font-weight:900;font-size:20px}

    /* CTA */
    .actions{display:flex;justify-content:flex-start;margin-top:18px;gap:12px}
    .btn{background:var(--primary);color:white;padding:12px 20px;border-radius:999px;border:none;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(37,99,235,0.12);transition:transform .18s}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--primary);border:1px solid var(--primary);font-weight:700}
    .btn[disabled]{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}

    /* small helper */
    .muted{color:var(--muted);font-size:13px}
    .price-small{color:var(--primary);font-weight:800}

    /* Animations */
    @keyframes fadeInUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:none}}
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr; padding:20px}
      .summary{position:relative;top:auto}
      header.app-header { padding: 12px 20px; border-radius: 10px; }
    }

    /* mobile tweaks */
    @media (max-width:520px){
      .cat-desc{display:none}
      .cat-price{text-align:left}
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loaderOverlay" class="loader-overlay" aria-hidden="false" role="status">
    <div class="loader-card" aria-hidden="false">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loader-text">Cargando opciones...</div>
      <div class="loader-sub">Buscando los mejores autos para tus fechas</div>
    </div>
  </div>

  <div class="wrap" id="mainContent" style="opacity:0;transform:translateY(8px)">

    <!-- HEADER: igual que index.html -->
    <header class="app-header" style="grid-column:1/-1">
      <img src="logo.png" alt="ChidoCar" class="logo" onclick="window.location.href='index.html'">
      <nav class="top-nav">
        <a href="index.html">Inicio</a>
        <a href="index.html#nosotros">Sobre Nosotros</a>
      </nav>
    </header>

    <!-- Left: categorias -->
    <div class="panel" id="leftPanel">
      <h1 class="title">Selecciona la categoria</h1>
      <p class="lead">Revisa tu información y selecciona una categoría (obligatorio).</p>

      <div class="categories" id="categoriesList" aria-live="polite">
        <!-- Items inserted por JS -->
      </div>

      <div class="small-note muted">Los precios mostrados son por día y pueden variar según disponibilidad.</div>

      <div style="margin-top:18px">
        <button id="nextBtn" class="btn" disabled>Siguiente</button>
        <button id="backBtn" class="btn secondary">Regresar</button>
      </div>
    </div>

    <!-- Right: resumen -->
    <aside class="summary" aria-labelledby="resumenTitle">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h3 id="resumenTitle">Resumen</h3>
       
      </div>

      <div class="summary-row"><div class="muted">Lugar</div><div id="rsLocation">—</div></div>
      <div class="summary-row"><div class="muted">Fecha salida</div><div id="rsDate">—</div></div>
      <div class="summary-row"><div class="muted">Hora salida</div><div id="rsTime">—</div></div>
      <div class="summary-row"><div class="muted">Fecha regreso</div><div id="rsReturn">—</div></div>
      <div class="summary-row"><div class="muted">Hora devolución</div><div id="rsReturnTime">—</div></div>
      <div class="summary-row"><div class="muted">Días</div><div id="rsDays">—</div></div>
      <div class="summary-row"><div class="muted">Categoría</div><div id="rsCategory">—</div></div>
      <div class="summary-row"><div class="muted">Precio (por día)</div><div id="rsPrice">$0</div></div>

      <div class="total"><strong>Total:</strong><div class="amount" id="rsTotal">$0</div></div>
    </aside>
  </div>

  <script>
    /* Datos de ejemplo: categorías (puedes modificar) */
    const categories = [
      { id: 'auto_pequeno_manual', name: 'Auto pequeño manual', desc: 'Nissan March, Renault kwid, Fiat mobi o similar', price: 490 },
      { id: 'sedan_intermedio_automatico', name: 'Sedan Intermedio automático', desc: 'Kia rio, mirage, Aveo, attitude o similar', price: 590 },
      { id: 'sedan_plus_automatico', name: 'Sedan plus automático', desc: 'Kia K3, Nissan versa o similar', price: 690 },
      { id: 'suv', name: 'SUV', desc: 'Chevrolet Groove, Duster o similar', price: 890 },
      { id: 'minivan_7_pasajeros', name: 'Minivan 7 pasajeros', desc: 'Avanza, ertiga, xpander o similar', price: 890 },
      { id: 'van_8_pasajeros', name: 'Van 8 pasajeros', desc: 'Sienna, Sedona, oddysey o similar', price: 990 }
    ];
    // Elementos
    const loader = document.getElementById('loaderOverlay');
    const mainContent = document.getElementById('mainContent');
    const categoriesList = document.getElementById('categoriesList');
    const rsLocation = document.getElementById('rsLocation');
    const rsDate = document.getElementById('rsDate');
    const rsTime = document.getElementById('rsTime');
    const rsReturn = document.getElementById('rsReturn');
    const rsReturnTime = document.getElementById('rsReturnTime'); // Nuevo campo
    const rsDays = document.getElementById('rsDays');
    const rsCategory = document.getElementById('rsCategory');
    const rsPrice = document.getElementById('rsPrice');
    const rsTotal = document.getElementById('rsTotal');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');

    // Cargar datos desde localStorage o query string como fallback
    function getRentaData(){
      let data = null;
      try {
        const raw = localStorage.getItem('chidocar_renta');
        if (raw) data = JSON.parse(raw);
      } catch(e){
        console.warn('Error parseando localStorage', e);
      }
      // fallback: query string
      if (!data) {
        const params = new URLSearchParams(location.search);
        if (params.toString()){
          data = {
            location: params.get('location') || '',
            date: params.get('date') || '',
            returnDate: params.get('returnDate') || '',
            time: params.get('time') || '',
            returnTime: params.get('returnTime') || '' // Nuevo campo
          };
        }
      }
      return data || { location:'Aeropuerto Internacional de Mérida', date:'', returnDate:'', time:'', returnTime:'' };
    }

    let renta = getRentaData();

    // formato hora 24h -> 12h AM/PM
    function formatTimeTo12(hourMinute) {
      if (!hourMinute) return '—';
      const parts = hourMinute.split(':');
      if (parts.length < 2) return hourMinute;
      let h = parseInt(parts[0], 10);
      const m = parts[1].padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12;
      if (h === 0) h = 12;
      return `${String(h).padStart(2, '0')}:${m} ${ampm}`;
    }

    // calcular días entre fechas (mínimo 1 día)
    function calculateDays(startDateStr, endDateStr) {
      if (!startDateStr || !endDateStr) return 1;
      // usar fechas en UTC (sin tiempo) para calcular días entre fechas calendario
      const start = new Date(startDateStr + 'T00:00:00');
      const end = new Date(endDateStr + 'T00:00:00');
      const msPerDay = 24 * 60 * 60 * 1000;
      const diff = Math.ceil((end - start) / msPerDay);
      return diff <= 0 ? 1 : diff;
    }

    // mostrar resumen inicial
    function displayRenta(){
      rsLocation.textContent = renta.location || '—';
      rsDate.textContent = renta.date || '—';
      rsTime.textContent = formatTimeTo12(renta.time || '');
      rsReturn.textContent = renta.returnDate || '—';
      rsReturnTime.textContent = formatTimeTo12(renta.returnTime || ''); // ← NUEVO
      rsCategory.textContent = renta.selectedCategory || '—';
      rsPrice.textContent = renta.selectedPrice ? `$${renta.selectedPrice}` : '$0';
      // calcular días y total (si ya hay categoria seleccionada)
      updateTotalsOnSummary();
    }
    displayRenta();

    // Generar lista de categorías
    function renderCategories(){
      categoriesList.innerHTML = '';
      categories.forEach(cat => {
        const wrap = document.createElement('div');
        wrap.className = 'cat';
        wrap.tabIndex = 0;
        wrap.dataset.id = cat.id;
        wrap.dataset.price = cat.price;

        // NOTE: no se incluye la "estrella" de favorito aquí
        wrap.innerHTML = `
          <div class="cat-left">
            <div class="radio-custom" aria-hidden="true"><i class="fas fa-check"></i></div>
            <div class="cat-info">
              <div class="cat-name">${cat.name}</div>
              <div class="cat-desc">${cat.desc}</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <div class="cat-price">$${cat.price}</div>
            <div class="muted" style="font-size:12px">por día</div>
          </div>
        `;

        // click and keyboard
        wrap.addEventListener('click', () => selectCategory(cat.id));
        wrap.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectCategory(cat.id); }});

        categoriesList.appendChild(wrap);
      });
    }

    renderCategories();

    // Mantener seleccionado
    let selectedId = null;

    function selectCategory(id){
      if (selectedId === id) return;
      selectedId = id;

      document.querySelectorAll('.cat').forEach(el=>{
        if (el.dataset.id === id) el.classList.add('selected');
        else el.classList.remove('selected');
      });

      const chosen = categories.find(c => c.id === id);
      if (!chosen) return;

      // actualizar renta en memoria
      renta.selectedCategory = chosen.name;
      renta.selectedPrice = chosen.price;

      // actualizar resumen
      rsCategory.textContent = chosen.name;
      rsPrice.textContent = `$${chosen.price}`;

      // recalcular totales según días
      updateTotalsOnSummary();

      // habilitar siguiente
      nextBtn.disabled = false;

      // guardar selección temporal en localStorage
      try {
        const current = JSON.parse(localStorage.getItem('chidocar_renta') || '{}');
        const merged = Object.assign({}, current, { selectedCategory: chosen.name, selectedPrice: chosen.price });
        localStorage.setItem('chidocar_renta', JSON.stringify(merged));
      } catch(e){ console.warn('No se pudo guardar la selección', e); }
    }

    // calcular y actualizar totales según fechas y categoría seleccionada
    function updateTotalsOnSummary(){
      const days = calculateDays(renta.date, renta.returnDate);
      rsDays.textContent = `${days} ${days === 1 ? 'día' : 'días'}`;

      const perDay = renta.selectedPrice ? Number(renta.selectedPrice) : 0;
      rsPrice.textContent = `$${perDay}`;
      const total = perDay * days;
      rsTotal.textContent = `$${total}`;

      // también actualizar renta en memoria (para persistencia)
      renta.days = days;
      renta.total = total;
      try {
        const raw = localStorage.getItem('chidocar_renta') || '{}';
        const current = JSON.parse(raw);
        const merged = Object.assign({}, current, { days, total });
        localStorage.setItem('chidocar_renta', JSON.stringify(merged));
      } catch(e){ /* no crítico */ }
    }

    // Botones
    nextBtn.addEventListener('click', () => {
      if (!selectedId) return;
      // guardar y redirigir (puedes cambiar a la siguiente página)
      try {
        const raw = localStorage.getItem('chidocar_renta') || '{}';
        const current = JSON.parse(raw);
        const chosen = categories.find(c => c.id === selectedId);
        const merged = Object.assign({}, current, { selectedCategory: chosen.name, selectedPrice: chosen.price, days: renta.days, total: renta.total, savedAt: new Date().toISOString() });
        localStorage.setItem('chidocar_renta', JSON.stringify(merged));
      } catch(e){ console.warn('guardar next', e); }
      // animación breve y redirección
      nextBtn.textContent = 'Cargando...';
      nextBtn.disabled = true;
      setTimeout(()=> {
        // Cambiar a la página que corresponda (checkout/pago/resumen final)
        window.location.href = 'confirmacion.html'; // ajustar según tu flujo
      }, 700);
    });

    backBtn.addEventListener('click', () => {
      history.back();
    });

    // Simular carga y entradas animadas
    function init(){
      // Rellenar resumen con los datos disponibles
      displayRenta();

      // Si ya existe selección en localStorage, marcarla
      try {
        const raw = localStorage.getItem('chidocar_renta');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed.selectedCategory) {
            const cat = categories.find(c => c.name === parsed.selectedCategory || c.id === parsed.selectedCategory);
            if (cat) {
              // marcar después de render
              setTimeout(()=> selectCategory(cat.id), 100);
            }
          } else {
            // si no hay selección, aún actualizamos totales (por si hay fechas)
            updateTotalsOnSummary();
          }
        } else {
          updateTotalsOnSummary();
        }
      } catch(e){
        updateTotalsOnSummary();
      }

      // animar la entrada después del loader
      mainContent.style.opacity = '1';
      mainContent.style.transform = 'none';
    }

    // Simulación de búsqueda: mostrar loader 700-1300ms
    (function showLoaderThenInit(){
      loader.style.opacity = '1';
      loader.style.pointerEvents = 'auto';
      // tiempo aleatorio simula búsqueda en servidor
      const ms = 700 + Math.round(Math.random()*600);
      setTimeout(()=> {
        loader.style.opacity = '0';
        loader.style.pointerEvents = 'none';
        setTimeout(()=> loader.style.display = 'none', 420);
        init();
      }, ms);
    })();

    // Escuchar cambios en localStorage desde otra pestaña (por si el usuario edita la fecha en index)
    window.addEventListener('storage', (e) => {
      if (e.key === 'chidocar_renta') {
        try {
          const parsed = JSON.parse(e.newValue || '{}');
          renta = Object.assign({}, renta, parsed);
          displayRenta();
        } catch(err){}
      }
    });

    // Por si el usuario regresa desde index y la página actualiza localStorage, comprobar cada segundo (opcional)
    let lastLS = localStorage.getItem('chidocar_renta');
    setInterval(() => {
      const now = localStorage.getItem('chidocar_renta');
      if (now !== lastLS) {
        lastLS = now;
        try {
          const parsed = JSON.parse(now || '{}');
          renta = Object.assign({}, renta, parsed);
          displayRenta();
        } catch(e){}
      }
    }, 900);

    // Mejora UX: accesibilidad, focus outline visible
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') document.body.classList.add('show-focus');
    });
  </script>
</body>
</html>