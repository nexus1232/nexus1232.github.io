<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChidoCar - Elegir Seguro</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --muted:#9ca3af;
      --bg:#f7f9fb;
      --card:#ffffff;
      --accent:#10b981;
      --radius:12px;
      --shadow: 0 8px 30px rgba(37, 99, 235, 0.08);
      --blue-soft: rgba(37,99,235,0.08);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    .wrap{max-width:1200px;margin:40px auto;padding:0 24px;display:grid;grid-template-columns:1fr 420px;gap:40px;align-items:start}

    header.app-header {
      background: white;
      padding: 20px 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      position: relative;
      z-index: 100;
      border-radius: 12px;
    }

    .logo { height: 60px; width: auto; cursor: pointer; transition: transform .2s; }
    .logo:hover { transform: scale(1.05); }

    nav.top-nav { display:flex; gap:28px; align-items:center; }
    nav.top-nav a { color:#666; text-decoration:none; font-size:15px; font-weight:500; position:relative; }
    nav.top-nav a::after { content:''; position:absolute; bottom:-5px; left:0; width:0; height:2px; background:var(--primary); transition:width .25s }
    nav.top-nav a:hover { color:var(--primary); } nav.top-nav a:hover::after { width:100%; }

    .loader-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(245,247,250,0.9)); z-index:9999; backdrop-filter: blur(6px); transition:opacity .4s ease; }
    .loader-card{ background:var(--card); padding:26px; border-radius:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:14px; align-items:center; }
    .spinner{ width:56px; height:56px; border-radius:50%; border:5px solid #e6eefc; border-top-color:var(--primary); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .loader-text{ font-weight:700; color:var(--primary) } .loader-sub{ font-size:13px; color:var(--muted) }

    .panel{ background:var(--card); border-radius:var(--radius); padding:28px; box-shadow:var(--shadow); }
    h1.title{ font-size:26px; margin-bottom:6px }
    p.lead{ color:var(--muted); margin-bottom:18px }

    .categories{ display:flex; flex-direction:column; gap:12px; margin-top:12px }
    .cat{ display:flex; align-items:flex-start; justify-content:space-between; padding:18px; border-radius:10px; border:1px solid rgba(15,23,42,0.04); cursor:pointer; transition:all .22s; background:linear-gradient(180deg, transparent, rgba(0,0,0,0.01)); overflow:hidden; flex-wrap:wrap; }
    .cat:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(16,24,40,0.06) }
    .cat.selected{ border:2px solid var(--primary); box-shadow:0 12px 32px var(--blue-soft); background:linear-gradient(180deg, rgba(37,99,235,0.03), transparent) }
    .cat-left{ display:flex; flex-direction:column; gap:6px; min-width:0; flex:1 }
    .radio-custom{ width:18px; height:18px; border-radius:50%; border:2px solid var(--muted); display:flex; align-items:center; justify-content:center; flex-shrink:0; background:white; transition:all .22s; margin-right:12px; margin-top:4px; }
    .cat.selected .radio-custom{ border-color:var(--primary); background:var(--primary) }
    .radio-custom i{ color:white; font-size:10px; opacity:0; transition:opacity .18s }
    .cat.selected .radio-custom i{ opacity:1 }

    .cat-info{ min-width:0 }
    .cat-name{ font-weight:700; font-size:15px; color:#0b1220; white-space:normal; }
    .cat-desc{ font-size:13px; color:var(--muted); margin-top:4px; white-space:normal; line-height:1.3; max-width:100% }
    .cat-price{ font-weight:800; color:var(--primary); font-size:16px; min-width:72px; text-align:right; flex-shrink:0; white-space:nowrap }

    .small-note{ font-size:13px; color:var(--muted); margin-top:14px }

    .summary{ background:linear-gradient(180deg,#fff,#fbfdff); border-radius:var(--radius); padding:22px; border:1px solid rgba(15,23,42,0.03); box-shadow:var(--shadow); position:sticky; top:26px; align-self:start; }
    .summary h3{ margin-bottom:6px; color:#111827 }
    .step{ font-size:13px; color:var(--muted); float:right }
    .summary-row{ display:flex; justify-content:space-between; padding:10px 6px; border-bottom:1px dashed rgba(15,23,42,0.05); align-items:center }
    .total{ display:flex; justify-content:space-between; padding-top:18px; align-items:center }
    .total strong{ font-size:20px } .total .amount{ color:var(--primary); font-weight:900; font-size:20px }

    .actions{ display:flex; justify-content:flex-start; margin-top:18px; gap:12px }
    .btn{ background:var(--primary); color:white; padding:12px 20px; border-radius:999px; border:none; font-weight:800; cursor:pointer; box-shadow:0 10px 30px rgba(37,99,235,0.12); transition:transform .18s }
    .btn:active{ transform:translateY(1px) }
    .btn.secondary{ background:transparent; color:var(--primary); border:1px solid var(--primary); font-weight:700 }
    .btn[disabled]{ opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none }

    .muted{ color:var(--muted); font-size:13px }
    .price-small{ color:var(--primary); font-weight:800 }

    @media (max-width:980px){
      .wrap{ grid-template-columns:1fr; padding:20px }
      .summary{ position:relative; top:auto }
      header.app-header { padding:12px 20px; border-radius:10px; }
    }

    @media (max-width:520px){
      .cat-desc{ display:block } .cat-price{text-align:left}
    }

    /* simple input style */
    .client-input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); margin-top:12px; font-size:15px }
    .client-label { font-weight:700; margin-top:8px; display:block; font-size:14px }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loaderOverlay" class="loader-overlay" aria-hidden="false" role="status">
    <div class="loader-card" aria-hidden="false">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loader-text">Cargando opciones...</div>
      <div class="loader-sub">Buscando los mejores seguros para tu viaje</div>
    </div>
  </div>

  <div class="wrap" id="mainContent" style="opacity:0;transform:translateY(8px)">

    <!-- HEADER -->
    <header class="app-header" style="grid-column:1/-1">
      <img src="logo.png" alt="ChidoCar" class="logo" onclick="window.location.href='index.html'">
      <nav class="top-nav">
        <a href="index.html">Inicio</a>
        <a href="index.html#nosotros">Sobre Nosotros</a>
      </nav>
    </header>

    <!-- Left: seguros -->
    <div class="panel" id="leftPanel">
      <h1 class="title">Selecciona el tipo de seguro</h1>
      <p class="lead">Revisa tu informaci√≥n y selecciona un seguro (obligatorio).</p>

      <div id="catAlert" style="display:none;margin-bottom:12px;padding:12px;border-radius:8px;background:#fff5f5;color:#7f1d1d;border:1px solid rgba(127,29,29,0.06)">
        No se encontr√≥ la categor√≠a del auto. Regresa a la selecci√≥n de categor√≠a para elegir un auto primero.
      </div>

      <div class="categories" id="categoriesList" aria-live="polite"></div>

      <label class="client-label" for="clientNameInput">Nombre del cliente (obligatorio)</label>
      <input id="clientNameInput" class="client-input" type="text" placeholder="Ej. Juan P√©rez" autocomplete="name">

      <div class="small-note muted">Los precios de seguro son por d√≠a y var√≠an seg√∫n la categor√≠a del auto.</div>

      <div style="margin-top:18px">
        <button id="nextBtn" class="btn" disabled>Confirmar</button>
        <button id="backBtn" class="btn secondary">Regresar</button>
      </div>
    </div>

    <!-- Right: resumen -->
    <aside class="summary" aria-labelledby="resumenTitle">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h3 id="resumenTitle">Resumen</h3>
        
      </div>

      <div class="summary-row"><div class="muted">Lugar</div><div id="rsLocation">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Fecha salida</div><div id="rsDate">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Hora salida</div><div id="rsTime">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Fecha regreso</div><div id="rsReturn">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Hora devoluci√≥n</div><div id="rsReturnTime">‚Äî</div></div>
      <div class="summary-row"><div class="muted">D√≠as</div><div id="rsDays">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Categor√≠a</div><div id="rsCategory">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Cliente</div><div id="rsClient">‚Äî</div></div>
      <div class="summary-row"><div class="muted">Precio auto (por d√≠a)</div><div id="rsPrice">$0.00</div></div>
      <div class="summary-row"><div class="muted">Seguro (por d√≠a)</div><div id="rsInsurancePricePerDay">$0.00</div></div>
      <div class="summary-row"><div class="muted">Seguro (total)</div><div id="rsInsuranceTotal">$0.00</div></div>

      <div class="summary-row"><div class="muted">Subtotal (auto + seguro)</div><div id="rsSubtotal">$0.00</div></div>
      <div class="summary-row"><div class="muted">IVA (16%)</div><div id="rsIva">$0.00</div></div>

      <div class="total"><strong>Total:</strong><div class="amount" id="rsTotal">$0.00</div></div>
    </aside>
  </div>

  <script>
    const IVA_RATE = 0.16;

    const insuranceTypes = [
      { id: 'basico', name: 'üöó CHIDO B√ÅSICO', desc: `Lo esencial para tu viaje:\nResponsabilidad civil a terceros\nDa√±os materiales y robo total con deducible 10% valor comercial del veh√≠culo\nAsistencia b√°sica` },
      { id: 'plus', name: '‚≠ê CHIDO PLUS', desc: `La opci√≥n m√°s elegida:\n‚úÖ Cubre llantas\n‚úÖ Da√±os materiales y robo total con deducible 5% valor comercial del veh√≠culo\n‚úÖ Sin cargos adicionales por lavados` },
      { id: 'total', name: 'üåü CHIDO TOTAL', desc: `M√°xima tranquilidad, pagas $0 pesos si pasa algo\n‚úÖ Sin deducible\n‚úÖ Cubre llantas, cristales y espejos\n‚úÖ Cobertura de robo parcial y da√±os materiales\n‚úÖ Procesos prioritarios en caso de incidente` }
    ];

    const insurancePriceMap = {
      'auto_pequeno_manual':    { basico: 190, plus: 290, total: 390 },
      'sedan_intermedio_automatico': { basico: 190, plus: 390, total: 490 },
      'sedan_plus_automatico':  { basico: 190, plus: 390, total: 490 },
      'suv':                    { basico: 190, plus: 390, total: 590 },
      'minivan_7_pasajeros':    { basico: 190, plus: 390, total: 590 },
      'van_8_pasajeros':        { basico: 190, plus: 390, total: 690 }
    };

    const insurancePriceMapByName = {
      'Auto peque√±o manual':    insurancePriceMap['auto_pequeno_manual'],
      'Econ√≥mico Manual':       insurancePriceMap['auto_pequeno_manual'],
      'Sedan Intermedio autom√°tico': insurancePriceMap['sedan_intermedio_automatico'],
      'Intermedio Autom√°tico':  insurancePriceMap['sedan_intermedio_automatico'],
      'Sedan plus autom√°tico':  insurancePriceMap['sedan_plus_automatico'],
      'Sedan Plus autom√°tico':  insurancePriceMap['sedan_plus_automatico'],
      'SUV':                    insurancePriceMap['suv'],
      'Minivan 7 pasajeros':    insurancePriceMap['minivan_7_pasajeros'],
      'Minivan (7 Pasajeros)':  insurancePriceMap['minivan_7_pasajeros'],
      'Van 8 pasajeros':        insurancePriceMap['van_8_pasajeros'],
      'Van (8 Pasajeros)':      insurancePriceMap['van_8_pasajeros']
    };

    const loader = document.getElementById('loaderOverlay');
    const mainContent = document.getElementById('mainContent');
    const categoriesList = document.getElementById('categoriesList');
    const catAlert = document.getElementById('catAlert');

    const rsLocation = document.getElementById('rsLocation');
    const rsDate = document.getElementById('rsDate');
    const rsTime = document.getElementById('rsTime');
    const rsReturn = document.getElementById('rsReturn');
    const rsReturnTime = document.getElementById('rsReturnTime'); // Nuevo campo
    const rsDays = document.getElementById('rsDays');
    const rsCategory = document.getElementById('rsCategory');
    const rsClient = document.getElementById('rsClient');
    const rsPrice = document.getElementById('rsPrice');
    const rsInsurancePricePerDay = document.getElementById('rsInsurancePricePerDay');
    const rsInsuranceTotal = document.getElementById('rsInsuranceTotal');
    const rsSubtotal = document.getElementById('rsSubtotal');
    const rsIva = document.getElementById('rsIva');
    const rsTotal = document.getElementById('rsTotal');

    const clientNameInput = document.getElementById('clientNameInput');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');

    function getRentaData(){
      let data = null;
      try {
        const raw = localStorage.getItem('chidocar_renta');
        if (raw) data = JSON.parse(raw);
      } catch(e){
        console.warn('Error parseando localStorage', e);
      }
      if (!data) {
        const params = new URLSearchParams(location.search);
        if (params.toString()){
          data = {
            location: params.get('location') || '',
            date: params.get('date') || '',
            returnDate: params.get('returnDate') || '',
            time: params.get('time') || '',
            returnTime: params.get('returnTime') || '', // Nuevo campo
            selectedCategory: params.get('selectedCategory') || '',
            selectedPrice: Number(params.get('selectedPrice') || 0),
            days: Number(params.get('days') || 1),
            selectedInsuranceId: params.get('selectedInsuranceId') || '',
            selectedInsurancePricePerDay: Number(params.get('selectedInsurancePricePerDay') || 0),
            clientName: params.get('clientName') || ''
          };
        }
      }
      return data || { location:'Aeropuerto Internacional de M√©rida', date:'', returnDate:'', time:'', returnTime:'', selectedCategory:'', selectedPrice:0, days:1, selectedInsuranceId:'', selectedInsurancePricePerDay:0, clientName: '' };
    }

    let renta = getRentaData();

    function formatTimeTo12(hourMinute) {
      if (!hourMinute) return '‚Äî';
      const parts = hourMinute.split(':');
      if (parts.length < 2) return hourMinute;
      let h = parseInt(parts[0], 10);
      const m = parts[1].padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12;
      if (h === 0) h = 12;
      return `${String(h).padStart(2, '0')}:${m} ${ampm}`;
    }

    function calculateDays(startDateStr, endDateStr) {
      if (!startDateStr || !endDateStr) return 1;
      const start = new Date(startDateStr + 'T00:00:00');
      const end = new Date(endDateStr + 'T00:00:00');
      const msPerDay = 24 * 60 * 60 * 1000;
      const diff = Math.ceil((end - start) / msPerDay);
      return diff <= 0 ? 1 : diff;
    }

    function formatCurrency(n) {
      const value = Number(n) || 0;
      return value.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getInsurancePricesForCategory(catIdOrName) {
      if (!catIdOrName) return null;
      if (insurancePriceMap[catIdOrName]) return insurancePriceMap[catIdOrName];
      if (insurancePriceMapByName[catIdOrName]) return insurancePriceMapByName[catIdOrName];
      const key = String(catIdOrName).toLowerCase();
      if (key.includes('suv')) return insurancePriceMap['suv'];
      if (key.includes('mini') || key.includes('minivan')) return insurancePriceMap['minivan_7_pasajeros'];
      if (key.includes('van') && key.includes('8')) return insurancePriceMap['van_8_pasajeros'];
      if (key.includes('intermed') || key.includes('rio') || key.includes('mirage')) return insurancePriceMap['sedan_intermedio_automatico'];
      if (key.includes('plus') || key.includes('k3') || key.includes('versa')) return insurancePriceMap['sedan_plus_automatico'];
      if (key.includes('econom') || key.includes('pequeno') || key.includes('march') || key.includes('kwid')) return insurancePriceMap['auto_pequeno_manual'];
      return null;
    }

    function displayRenta(){
      rsLocation.textContent = renta.location || '‚Äî';
      rsDate.textContent = renta.date || '‚Äî';
      rsTime.textContent = formatTimeTo12(renta.time || '');
      rsReturn.textContent = renta.returnDate || '‚Äî';
      rsReturnTime.textContent = formatTimeTo12(renta.returnTime || ''); // Nuevo campo
      const days = renta.days ? Number(renta.days) : calculateDays(renta.date, renta.returnDate);
      rsDays.textContent = `${days} ${days === 1 ? 'd√≠a' : 'd√≠as'}`;
      rsCategory.textContent = renta.selectedCategory || '‚Äî';
      rsClient.textContent = renta.clientName || '‚Äî';
      rsPrice.textContent = renta.selectedPrice ? formatCurrency(renta.selectedPrice) : formatCurrency(0);
      if (renta.selectedInsurancePricePerDay) {
        rsInsurancePricePerDay.textContent = formatCurrency(renta.selectedInsurancePricePerDay) + '/d√≠a';
      } else {
        rsInsurancePricePerDay.textContent = formatCurrency(0);
      }
      updateTotalsOnSummary();
    }

    function renderInsurances(){
      categoriesList.innerHTML = '';
      const priceObj = getInsurancePricesForCategory(renta.selectedCategory || renta.selectedCategoryId);
      if (!priceObj) {
        catAlert.style.display = 'block';
      } else {
        catAlert.style.display = 'none';
      }

      insuranceTypes.forEach(type => {
        const perDay = priceObj ? (priceObj[type.id] || 0) : 0;
        const wrap = document.createElement('div');
        wrap.className = 'cat';
        wrap.tabIndex = 0;
        wrap.dataset.id = type.id;
        wrap.dataset.pricePerDay = perDay;

        wrap.innerHTML = `
          <div class="cat-left">
            <div class="radio-custom" aria-hidden="true"><i class="fas fa-check"></i></div>
            <div class="cat-info">
              <div class="cat-name">${type.name} <span style="font-weight:800;color:var(--primary);margin-left:8px">${perDay? formatCurrency(perDay): ''}</span></div>
              <div class="cat-desc" style="white-space: pre-line;">${type.desc}</div>
            </div>
          </div>
          <div class="cat-price">${perDay ? formatCurrency(perDay) + '/d√≠a' : '‚Äî'}</div>
        `;

        wrap.addEventListener('click', () => selectInsurance(type.id, perDay));
        wrap.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectInsurance(type.id, perDay); }});

        if (renta.selectedInsuranceId && renta.selectedInsuranceId === type.id) {
          wrap.classList.add('selected');
        }

        categoriesList.appendChild(wrap);
      });
    }

    let selectedInsuranceId = renta.selectedInsuranceId || null;
    let selectedInsurancePricePerDay = renta.selectedInsurancePricePerDay || 0;

    function enableNextIfReady() {
      const hasInsurance = !!selectedInsuranceId;
      const hasName = !!(clientNameInput.value && clientNameInput.value.trim().length > 1);
      nextBtn.disabled = !(hasInsurance && hasName);
    }

    clientNameInput.addEventListener('input', () => {
      const name = clientNameInput.value.trim();
      renta.clientName = name;
      rsClient.textContent = name || '‚Äî';
      try {
        const current = JSON.parse(localStorage.getItem('chidocar_renta') || '{}');
        current.clientName = name;
        localStorage.setItem('chidocar_renta', JSON.stringify(current));
      } catch(e){}
      enableNextIfReady();
    });

    function selectInsurance(id, perDay){
      if (!perDay) {
        alert('No hay precios de seguro disponibles para la categor√≠a seleccionada. Regresa a seleccionar un auto.');
        return;
      }
      selectedInsuranceId = id;
      selectedInsurancePricePerDay = perDay;

      document.querySelectorAll('.cat').forEach(el=>{
        if (el.dataset.id === id) el.classList.add('selected');
        else el.classList.remove('selected');
      });

      renta.selectedInsuranceId = id;
      renta.selectedInsuranceName = insuranceTypes.find(t => t.id === id).name;
      renta.selectedInsurancePricePerDay = perDay;

      try {
        const current = JSON.parse(localStorage.getItem('chidocar_renta') || '{}');
        const merged = Object.assign({}, current, {
          selectedInsuranceId: renta.selectedInsuranceId,
          selectedInsuranceName: renta.selectedInsuranceName,
          selectedInsurancePricePerDay: renta.selectedInsurancePricePerDay
        });
        localStorage.setItem('chidocar_renta', JSON.stringify(merged));
      } catch(e){ console.warn('No se pudo guardar la selecci√≥n de seguro', e); }

      updateTotalsOnSummary();
      enableNextIfReady();
    }

    function updateTotalsOnSummary(){
      const days = Number(renta.days) || calculateDays(renta.date, renta.returnDate);
      const perDayAuto = Number(renta.selectedPrice) || 0;
      const perDayInsurance = Number(renta.selectedInsurancePricePerDay) || Number(selectedInsurancePricePerDay || 0);

      const autoTotal = perDayAuto * days;
      const insuranceTotal = perDayInsurance * days;
      const subtotal = autoTotal + insuranceTotal;
      const iva = +(subtotal * IVA_RATE);
      const grandTotal = subtotal + iva;

      rsInsurancePricePerDay.textContent = perDayInsurance ? formatCurrency(perDayInsurance) + '/d√≠a' : formatCurrency(0);
      rsInsuranceTotal.textContent = formatCurrency(insuranceTotal);
      rsSubtotal.textContent = formatCurrency(subtotal);
      rsIva.textContent = formatCurrency(iva);
      rsTotal.textContent = formatCurrency(grandTotal);

      rsPrice.textContent = perDayAuto ? formatCurrency(perDayAuto) : formatCurrency(0);
      rsDays.textContent = `${days} ${days === 1 ? 'd√≠a' : 'd√≠as'}`;

      renta.days = days;
      renta.autoTotal = autoTotal;
      renta.insuranceTotal = insuranceTotal;
      renta.subtotal = subtotal;
      renta.iva = iva;
      renta.total = grandTotal;

      try {
        const raw = localStorage.getItem('chidocar_renta') || '{}';
        const current = JSON.parse(raw);
        const merged = Object.assign({}, current, {
          days,
          autoTotal,
          insuranceTotal,
          subtotal,
          iva,
          total: grandTotal,
          selectedInsuranceId: renta.selectedInsuranceId || '',
          selectedInsurancePricePerDay: renta.selectedInsurancePricePerDay || 0,
          clientName: renta.clientName || ''
        });
        localStorage.setItem('chidocar_renta', JSON.stringify(merged));
      } catch(e){ /* no cr√≠tico */ }
    }

    nextBtn.addEventListener('click', () => {
      const name = (clientNameInput.value || '').trim();
      if (!selectedInsuranceId) {
        alert('Por favor selecciona un seguro antes de confirmar.');
        return;
      }
      if (!name || name.length < 2) {
        alert('Por favor ingresa el nombre del cliente.');
        return;
      }

      renta.clientName = name;

      try {
        const raw = localStorage.getItem('chidocar_renta') || '{}';
        const current = JSON.parse(raw);
        const merged = Object.assign({}, current, {
          selectedInsuranceId: renta.selectedInsuranceId,
          selectedInsuranceName: renta.selectedInsuranceName,
          selectedInsurancePricePerDay: renta.selectedInsurancePricePerDay,
          days: renta.days,
          autoTotal: renta.autoTotal,
          insuranceTotal: renta.insuranceTotal,
          subtotal: renta.subtotal,
          iva: renta.iva,
          total: renta.total,
          clientName: renta.clientName,
          savedAt: new Date().toISOString()
        });
        localStorage.setItem('chidocar_renta', JSON.stringify(merged));
      } catch(e){ console.warn('guardar next', e); }

      // Construir mensaje para WhatsApp (incluye todos los detalles y SOLO el nombre del cliente)
      const phone = '529991569221'; 
      const lines = [];
      lines.push('¬°Hola! Quiero confirmar mi reserva en ChidoCar con los siguientes detalles:');
      lines.push('');
      lines.push(`Lugar: ${renta.location || '‚Äî'}`);
      lines.push(`Fecha salida: ${renta.date || '‚Äî'}`);
      lines.push(`Hora salida: ${formatTimeTo12(renta.time || '')}`);
      lines.push(`Fecha regreso: ${renta.returnDate || '‚Äî'}`);
      lines.push(`Hora devoluci√≥n: ${formatTimeTo12(renta.returnTime || '')}`);
      lines.push(`D√≠as: ${renta.days || 1}`);
      lines.push('');
      lines.push(`Categor√≠a de auto: ${renta.selectedCategory || '‚Äî'}`);
      lines.push(`Precio auto (por d√≠a): ${formatCurrency(renta.selectedPrice || 0)}`);
      lines.push(`Total auto (${renta.days || 1} ${renta.days == 1 ? 'd√≠a' : 'd√≠as'}): ${formatCurrency(renta.autoTotal || 0)}`);
      lines.push('');
      lines.push(`Seguro seleccionado: ${renta.selectedInsuranceName || '‚Äî'}`);
      lines.push(`Precio seguro (por d√≠a): ${formatCurrency(renta.selectedInsurancePricePerDay || 0)}`);
      lines.push(`Seguro (total ${renta.days || 1} ${renta.days == 1 ? 'd√≠a' : 'd√≠as'}): ${formatCurrency(renta.insuranceTotal || 0)}`);
      lines.push('');
      lines.push(`Subtotal: ${formatCurrency(renta.subtotal || 0)}`);
      lines.push(`IVA (16%): ${formatCurrency(renta.iva || 0)}`);
      lines.push(`Total a pagar: ${formatCurrency(renta.total || 0)}`);
      lines.push('');
      // Solo el nombre del cliente como pidi√≥
      lines.push(`Nombre del cliente: ${renta.clientName || '‚Äî'}`);
      lines.push('');
      lines.push('Gracias.');

      const message = encodeURIComponent(lines.join('\n'));
      const url = `https://wa.me/${phone}?text=${message}`;

      nextBtn.textContent = 'Enviando...';
      nextBtn.disabled = true;
      window.open(url, '_blank');

      setTimeout(() => { nextBtn.textContent = 'Enviado'; }, 1200);
    });

    backBtn.addEventListener('click', () => { history.back(); });

    function init(){
      // Fill client input if saved
      clientNameInput.value = renta.clientName || '';
      displayRenta();
      renderInsurances();

      try {
        const raw = localStorage.getItem('chidocar_renta');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed.selectedInsuranceId) {
            setTimeout(() => {
              renta = Object.assign({}, renta, parsed);
              selectedInsuranceId = parsed.selectedInsuranceId;
              selectedInsurancePricePerDay = parsed.selectedInsurancePricePerDay || selectedInsurancePricePerDay;
              document.querySelectorAll('.cat').forEach(el => {
                if (el.dataset.id === selectedInsuranceId) el.classList.add('selected');
              });
              updateTotalsOnSummary();
            }, 120);
          } else {
            updateTotalsOnSummary();
          }
        } else {
          updateTotalsOnSummary();
        }
      } catch(e){
        updateTotalsOnSummary();
      }

      enableNextIfReady();
      mainContent.style.opacity = '1';
      mainContent.style.transform = 'none';
    }

    (function showLoaderThenInit(){
      loader.style.opacity = '1';
      loader.style.pointerEvents = 'auto';
      const ms = 700 + Math.round(Math.random()*600);
      setTimeout(() => {
        loader.style.opacity = '0';
        loader.style.pointerEvents = 'none';
        setTimeout(() => loader.style.display = 'none', 420);
        init();
      }, ms);
    })();

    window.addEventListener('storage', (e) => {
      if (e.key === 'chidocar_renta') {
        try {
          const parsed = JSON.parse(e.newValue || '{}');
          renta = Object.assign({}, renta, parsed);
          clientNameInput.value = renta.clientName || '';
          displayRenta();
          renderInsurances();
        } catch(err){}
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') document.body.classList.add('show-focus');
    });
  </script>
</body>
</html>